---
layout: post
title: Creating an Environment Using Conda
subtitle: Online and Offline
tags: [Conda]
comments: true
mathjax: true
author: KongKong
categories: [sc]
---

<div class="box-success">
<p><strong>Conda</strong> is an efficient package management tool that allows users 
to install all required packages with a single command, simply by specifying what they need.
Download <a href="https://www.anaconda.com/download/success">Anaconda</a>,
though I personally recommend <a href="https://www.anaconda.com/download/success">Miniconda</a>.</p>

<p>In this blog, there are <strong>3</strong> main parts:</p>
<ul>
  <li>Quick guide to creating an environment with Conda (online)</li>
  <li>Switching to a different Conda source (mirror)</li>
  <li>Creating an environment with Conda offline</li>
</ul>
</div>

We will create an environment named `SCenv` containing the following packages:
- gcc
- mpich
- cmake
- make

## Creating `SCenv` with Conda online

First, create the environment with the required packages. 
Note that we will generally need to add the conda-forge channel:

```shell
conda create -n SCenv \
  compilers \
  mpich \
  cmake \
  make \
  -c conda-forge
```

After the packages are downloaded, activate the `SCenv` environment:

```shell
conda activate SCenv
```

Finally, `SCenv` environment is now ready to use.

## Switching the Conda mirror source

In some cases, the official Conda source may have slow download speeds. 
Switching to a mirror source can significantly improve download performance. 
This section explains how to configure Conda to use the **Tsinghua mirror source**.

First, edit the `.condarc` configuration file:

```shell
vim ~/.condarc
```

Then, add the following content:

```yaml
channels:
  - defaults
show_channel_urls: true
default_channels:
  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main
  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/r
  - https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/msys2
custom_channels:
  conda-forge: https://mirrors.tuna.tsinghua.edu.cn/anaconda/cloud
```

After saving the file, Conda will use the **Tsinghua mirror source** for future operations.

## Creating `SCenv` with Conda offline

In certain situations — such as working on an offline cluster —
Conda cannot download packages directly. 
It is therefore essential to know 
how to set up a Conda environment without an internet connection.

There are two common approaches, 
both of which require first preparing 
the environment on a machine with internet access:

1. **Pack the `SCenv` environment on an online computer**,
then transfer and unpack it on the target offline system.. 
For more details, refer to [conda-pack](https://conda.github.io/conda-pack/);

2. **Set up a local channel**.
This allows you to create the `SCenv` environment on the offline cluster 
in a similar way as on an online machine. 
This section will focus on this method.

{: .box-note}
**Note:** Unless otherwise specified, 
all subsequent commands assume that 
the `SCenv` environment is activated 
(i.e., `conda activate SCenv` has been executed).

**Step 1: Export the Package List on an Online Machine**

```shell
conda list --explicit > environment.txt
```

**Step 2: Download the Required Packages**

Create and run a download script on the online machine:

```shell
touch download.sh
chmod +x download.sh
```

edit `download.sh` with the following content:

```shell
#!/bin/bash

# downloaded directories
mkdir -p conda_packages
cd conda_packages

# download all packages in environment.txt
while read -r url; do
    # lines begin with http
    if [[ $url == http* ]]; then
        echo "downloading: $url"
        wget --user-agent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/96.0.4664.110 Safari/537.36" "$url"
    fi
done < ../environment.txt

echo "All files has been downloaded into DIR: conda_packages"
```

**Step 3: Generate Package Index and Prepare for Transfer**

Install `conda-build` if not already present:

```shell
conda install conda-build
```

Organize the packages into platform-specific subdirectories 
(e.g., `linux-64` or `noarch`) under `conda_packages`, 
then generate the repository metadata:

```shell
cd conda_packages
python -m conda_index .
```

This will create index files such as 
`repodata.json` and `current_repodata.json` 
in the corresponding subdirectories.

Package the directory for transfer:

```shell
tar -zcvf conda_packages.tar.gz conda_packages/
```

Transfer the `conda_packages.tar.gz` file to the offline cluster.

**Step 4: Set Up the Environment on the Offline Cluster**

Extract the packages on the offline cluster (ensure Conda is installed):

```shell
tar -zcvf conda_packages.tar.gz
```

Create the `SCenv` environment using the local channel:

```shell
conda create -n SCenv \
--offline \
--solver=classic \
-c file:///path/to/conda_packages \
compilers cmake mpich make
```

Activate the new environment:

```shell
conda activate SCenv
```

To enable future offline indexing, we can install `conda-build` locally:

```shell
conda install conda-build \
--offline \
-c file:///path/to/conda_packages
```

**Step 5: (Optional) Add New Packages to the Local Channel**

To add new packages to local channel, 
place them in the appropriate subdirectory 
under `conda_packages`, then regenerate the index:

```shell
python -m conda_index /path/to/conda_packages
```

This updates `repodata.json` and related index files.

## Conclusions

In this blog post, we demonstrated 
how to create Conda environments both online and offline. 
By leveraging local channels and offline package management, 
Conda continues to provide a powerful and flexible solution 
for software environment configuration — even in restricted network environments.